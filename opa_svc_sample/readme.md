## Using OPA as a standalone/sidecar service

OPA can run in server mode. And following the sidecar pattern it can be used for:

- uploading 1..N x `Policy` (one or multiple policies)
- feeding in `Data`
  - representing facts about external world (attributes of users, request/action, or target)
- doing a `Query` for getting authorization decisions

```
      policies & data mgmt                authorization decisions
  ----------------------------           -------------------------


   .--------.    /policies/products
   | Policy |----------------------.
   '--------'                      |
                                   v
                              .---------.           .-------.
                              |   OPA   |<----------| Query |
                              '---------'           '-------'
                                   ^
   .--------.                      |
   |  Data  |----------------------'
   '--------'    /data/products/acl
```

### Usage

Follow these steps:

1. Start OPA in server mode.

   - Use `./run_opa.sh` script or run `opa run --server`.
   - It will listen on port `8181` for HTTP requests.

1. Upload the `Policy`.

   - Use `./upload_policy.sh` script or run:<br/>
     `curl -X PUT localhost:8181/v1/policies/products --data-binary @products_policy.rego`

1. Upload the `Data`.

   - Use `./upload_data.sh` script or run:<br/>
     `curl -X PUT localhost:8181/v1/data/products/acl --data-binary @products_acl.json`

1. `Query` for authorization decisions.

   - Use `./query_authz.sh` script or run:<br/>
     `curl -X POST localhost:8181/v1/data/products/policy/user_has_product --data-binary @query_input.json`<br/>
     and the response must be:<br/>
     `{"result":true}`

Of course, you can play with different values in `query_input` and run `./query_authz.sh` again to see the effect,<br/>
such as specifying `user_2` (which according to the uploaded `data` he doesn't have access to `product_2`).

### Notes

1. It's important to load the policy using `--data-binary`, not just `-d`.
1. As the [docs](https://www.openpolicyagent.org/docs/latest/#rules) point out:<br>
   > All values generated by rules can be queried via the global `data` variable.
   > You can query the value of any rule loaded into OPA by referring to it with an absolute path. The path of a rule is always: `data.<package-path>.<rule-name>`.
